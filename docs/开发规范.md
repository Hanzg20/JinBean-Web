# 开发规范

## 8. Cloudflare Pages 部署问题与开发规范

### 8.1 环境变量与配置问题
- 所有生产环境变量必须在 Cloudflare Pages 控制台设置，不要依赖本地 .env。
- 敏感变量（如 Sentry、数据库连接）用 try/catch 包裹，缺失时警告但不阻断构建。
- 本地开发专用脚本（如本地数据库初始化）不要写入生产构建流程。

### 8.2 端口冲突与本地数据库问题
- 本地数据库服务启动脚本（如 pglite-server）不要加入生产构建命令，仅限本地开发。
- 生产构建命令中移除所有与本地数据库相关的 npm script。
- 如需数据库，建议用 Cloudflare D1、Supabase 等云服务，并用环境变量区分本地与生产连接。

### 8.3 Next.js 路由与布局问题
- 每个 app 目录下必须有 layout.tsx 和 page.tsx，即使只是简单包裹。
- 路由嵌套、文件命名严格遵循 Next.js 官方规范。
- 多语言路由（[locale]）要保证所有语言包和页面都齐全。

### 8.4 多语言（next-intl）与类型问题
- 导航等常用 key 建议全部扁平化到根部，如 "home": "首页"，调用时用 t('home')。
- 如需嵌套结构，需用 t('nav.home') 并保证 JSON 结构一致。
- 类型报错可用 (t as any)('key') 兜底，但建议长期用 next-intl 官方推荐的扁平 key + 自动类型生成方案。

### 8.5 Sentry、Clerk、第三方服务警告
- 所有第三方服务的 token 用环境变量注入，缺失时仅警告不阻断。
- 生产构建流程中可用 try/catch 包裹相关初始化，保证主流程不被影响。

### 8.6 CI/CD 自动化与分支规范
- 所有构建相关脚本、依赖、环境变量变更都要在 PR/合并前在 Cloudflare Pages 预览环境验证通过。
- 主分支（main/master）始终保持可部署状态，开发分支合并前本地和云端都要跑一遍 build。
- 如需自动推送/部署，建议用 GitHub Actions + Cloudflare Pages 集成。

### 8.7 端口冲突自查
- 本地开发遇到端口占用，需手动查杀进程或重启电脑。


## 多语言(i18n)开发与部署规范

### 1. 语言包 JSON 文件格式问题
- 语言包必须为**合法的 JSON**，**禁止添加注释**，禁止用 shell 命令拼接 JSON。
- 推荐用编辑器或专用 JSON 工具维护，必要时用 `jq` 检查格式：`jq . path/to/file.json`。

### 2. 多端/多目录语言包内容不一致
- 统一维护一份主语言包（如 `packages/i18n`），**所有端的 locales 文件均自动同步**，禁止手动分散维护。
- 新增/修改翻译时，**先改主语言包，再同步到各端**。

### 3. 缺失 namespace 或 key 导致类型错误
- **每个页面/组件用到的 namespace 必须在所有语言包中存在**，哪怕只加 meta_title、meta_description 占位。
- 新增页面时，**同步补充 namespace 到所有语言包**。

### 4. 自动化同步与校验
- 建议写自动脚本或在 CI 中校验：**所有 locales 必须和主语言包 key 完全一致**。
- 每次构建前自动覆盖同步，防止遗漏。

### 5. 注释与文档管理
- **禁止在 JSON 文件内写注释**，如需说明结构，单独写 markdown 文档（如 `zh.json.readme.md`）。

### 6. 常见命名规范
- **namespace 命名**：与页面/功能模块保持一致，首字母大写（如 `DashboardLayout`、`UserProfile`）。
- **key 命名**：推荐用小写加下划线或驼峰，保持一致性。

### 7. 构建与部署前自检清单
- 运行 `jq .` 检查所有 JSON 格式。
- 检查所有页面/组件用到的 namespace 是否在所有语言包中存在。
- 确认所有 locales 文件与主语言包内容一致。
- 禁止直接在 JSON 文件内加注释。 


## 多语言(i18n)开发与部署规范

### 1. 语言包 JSON 文件格式问题
- 语言包必须为**合法的 JSON**，**禁止添加注释**，禁止用 shell 命令拼接 JSON。
- 推荐用编辑器或专用 JSON 工具维护，必要时用 `jq` 检查格式：`jq . path/to/file.json`。

### 2. 多端/多目录语言包内容不一致
- 统一维护一份主语言包（如 `packages/i18n`），**所有端的 locales 文件均自动同步**，禁止手动分散维护。
- 新增/修改翻译时，**先改主语言包，再同步到各端**。

### 3. 缺失 namespace 或 key 导致类型错误
- **每个页面/组件用到的 namespace 必须在所有语言包中存在**，哪怕只加 meta_title、meta_description 占位。
- 新增页面时，**同步补充 namespace 到所有语言包**。

### 4. 自动化同步与校验
- 建议写自动脚本或在 CI 中校验：**所有 locales 必须和主语言包 key 完全一致**。
- 每次构建前自动覆盖同步，防止遗漏。

### 5. 注释与文档管理
- **禁止在 JSON 文件内写注释**，如需说明结构，单独写 markdown 文档（如 `zh.json.readme.md`）。

### 6. 常见命名规范
- **namespace 命名**：与页面/功能模块保持一致，首字母大写（如 `DashboardLayout`、`UserProfile`）。
- **key 命名**：推荐用小写加下划线或驼峰，保持一致性。

### 7. 构建与部署前自检清单
- 运行 `jq .` 检查所有 JSON 格式。
- 检查所有页面/组件用到的 namespace 是否在所有语言包中存在。
- 确认所有 locales 文件与主语言包内容一致。
- 禁止直接在 JSON 文件内加注释。 